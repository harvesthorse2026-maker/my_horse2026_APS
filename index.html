<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å¼·â€œè³½é¦¬ç ”ç©¶æ‰€â€œ</title>
    <style>
        :root { --primary-bg: #f2f4f8; --header-bg: #2c3e50; --card-bg: #ffffff; --text-main: #333333; --text-sub: #666666; --accent-green: #27ae60; --highlight-orange: #f39c12; --odds-red: #e74c3c; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--primary-bg); margin: 0; padding: 0; color: var(--text-main); -webkit-tap-highlight-color: transparent; }
        #loading-mask { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: #333; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid var(--header-bg); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .app-header { background-color: var(--header-bg); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between; }
        .header-title { font-size: 1.1rem; font-weight: bold; }
        .back-btn { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding-right: 15px; display: none; }
        .page { display: none; padding: 10px; padding-bottom: 70px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .race-info-header { background: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9rem; color: var(--text-sub); box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; }
        .race-card { background: var(--card-bg); border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; cursor: pointer; transition: transform 0.1s; }
        .race-card:active { transform: scale(0.98); }
        .race-card-top { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .race-id { font-size: 1.1rem; font-weight: bold; color: #2c3e50; }
        .race-meta { font-size: 0.9rem; color: var(--text-sub); }
        .race-card-body { padding: 12px 15px; display: grid; grid-template-columns: 1fr 1.3fr; gap: 10px; }
        .stat-row { margin-bottom: 5px; font-size: 0.9rem; display: flex; align-items: center; }
        .stat-label { color: var(--text-sub); margin-right: 5px; font-size: 0.85rem; }
        .stat-value { font-weight: bold; color: #333; }
        .color-bar { display: flex; gap: 4px; margin-top: 8px; }
        .c-block { width: 22px; height: 22px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bg-red { background-color: #e74c3c; } .bg-yellow { background-color: #f1c40f; } .bg-green { background-color: #2ecc71; } .bg-blue { background-color: #3498db; } .bg-purple { background-color: #9b59b6; }
        #quick-nav-container { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none; }
        #quick-nav-container::-webkit-scrollbar { display: none; }
        .quick-nav-btn { background: white; border: 1px solid #ddd; color: #666; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
        .quick-nav-btn.active { background: var(--header-bg); color: white; border-color: var(--header-bg); }
        .detail-header-info { text-align: center; margin-bottom: 15px; color: #555; font-size: 0.9rem; }
        .horse-list-header { display: grid; grid-template-columns: 3.5fr 1fr 1fr 1fr; padding: 0 10px 5px 10px; font-size: 0.8rem; color: #888; }
        .horse-card { background: white; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .h-main-row { padding: 12px 10px; display: grid; grid-template-columns: 3.5fr 1fr 1fr 1fr; align-items: center; border-bottom: 1px solid transparent; }
        .horse-card.expanded .h-main-row { background-color: #f9f9f9; border-bottom: 1px solid #eee; }
        .h-info-group { display: flex; align-items: center; }
        .h-num { background-color: var(--accent-green); color: white; width: 24px; height: 24px; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-size: 0.85rem; font-weight: bold; margin-right: 8px; flex-shrink: 0; }
        .h-name-box { display: flex; flex-direction: column; }
        .h-name { font-weight: bold; font-size: 1rem; display: flex; align-items: center; }
        .target-icon { font-size: 0.8rem; margin-left: 5px; }
        .h-sub-info { font-size: 0.75rem; color: #777; margin-top: 2px; }
        .h-stat-box { text-align: center; font-size: 0.95rem; font-weight: bold; }
        .odds-val { color: var(--odds-red); background: #fceceb; padding: 2px 4px; border-radius: 4px; }
        .rank-val { color: #333; }
        .pos-val { color: #2980b9; font-size: 0.85rem; }
        .h-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: #fdfdfd; }
        .h-details-content { padding: 12px 15px; font-size: 0.9rem; color: #444; line-height: 1.5; border-top: 1px dashed #eee; }
        .comment-label { color: var(--highlight-orange); font-weight: bold; margin-bottom: 4px; display: block; }
        .reason-section { margin-top: 10px; border-top: 1px solid #eee; padding-top: 8px; }
        .reason-label { color: #2980b9; font-weight: bold; font-size: 0.85rem; }
        .strategy-card { background: white; border-radius: 8px; margin-bottom: 15px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .strategy-title { font-size: 1.1rem; font-weight: bold; color: #2c3e50; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .strategy-content { font-size: 0.95rem; line-height: 1.6; color: #444; white-space: pre-wrap; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0; z-index: 99; }
        .nav-item { font-size: 0.7rem; text-align: center; color: #999; cursor: pointer; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;}
        .nav-item.active { color: var(--header-bg); font-weight: bold; }
        .nav-icon { font-size: 1.2rem; display: block; margin-bottom: 2px;}
    </style>
</head>
<body>
    <div id="loading-mask"><div class="spinner"></div><div>è³‡æ–™è®€å–ä¸­...</div></div>
    <header class="app-header">
        <button class="back-btn" id="backBtn" onclick="showPage('home')">â®</button>
        <div class="header-title" id="pageTitle">å°å¼·â€œè³½é¦¬ç ”ç©¶æ‰€â€œ</div>
        <div style="width: 30px;"></div>
    </header>

    <div id="page-home" class="page active">
        <div class="race-info-header" id="today-info"><span>ğŸ“… ...</span><span>ğŸ“ ...</span></div>
        <div id="race-list-container"></div>
    </div>

    <div id="page-detail" class="page">
        <div id="quick-nav-container"></div>
        <div class="detail-header-info"><span id="detail-race-no">R?</span> - å°å¼·æ©Ÿæœƒæä¾›</div>
        <div class="horse-list-header">
            <div>é¦¬åŒ¹è³‡æ–™</div><div style="text-align:center">è³ ç‡</div><div style="text-align:center">è³ ç‡æ’åº</div><div style="text-align:center">èµ°ä½</div>
        </div>
        <div id="horse-container"></div>
    </div>

    <div id="page-strategy" class="page">
        <div id="strategy-container"><div style="text-align:center; padding:20px; color:#888;">è¼‰å…¥åˆ†æä¸­...</div></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="showPage('home')"><span class="nav-icon">ğŸ“Š</span>è³½äº‹</div>
        <div class="nav-item" onclick="showPage('strategy')"><span class="nav-icon">ğŸ“ˆ</span>æˆ°ç•¥</div>
        <div class="nav-item"><span class="nav-icon">ğŸ‘¤</span>ç”¨æˆ¶</div>
    </div>

    <script>
        // ============================================
        // ğŸ”´ è«‹åœ¨é€™è£¡è²¼ä¸Šä½ çš„ Google Script é•·ç¶²å€
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwulxaOFUKjd_1coiO7-m7CYENgKiu0F3pv8DXJ-SJEJZkx2ogesjnTnNQWEEXABsHl/exec";
        // ============================================

        let globalData = null; 

        window.onload = async function() {
            try {
                const response = await fetch(SCRIPT_URL);
                const json = await response.json();
                
                if (Array.isArray(json)) { globalData = { races: json, analysis: [] }; } else { globalData = json; }
                
                renderHomeList(globalData.races);
                renderStrategy(globalData.analysis);
                
                if (globalData.races && globalData.races.length > 0) {
                    const dateTxt = globalData.races[0].date || "---";
                    const venueTxt = globalData.races[0].venue || "---";
                    document.querySelector('#today-info span:first-child').innerText = `ğŸ“… ${dateTxt}`;
                    document.querySelector('#today-info span:last-child').innerText = `ğŸ“ ${venueTxt}`;
                }
                document.getElementById('loading-mask').style.display = 'none';
            } catch (error) {
                console.error(error);
                alert("è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ã€‚\n" + error);
                document.getElementById('loading-mask').innerText = "è®€å–å¤±æ•—";
            }
        };

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('pageTitle').innerText = 'å°å¼·â€œè³½é¦¬ç ”ç©¶æ‰€â€œ';

            if (pageId === 'home') {
                document.getElementById('page-home').classList.add('active');
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } else if (pageId === 'strategy') {
                document.getElementById('page-strategy').classList.add('active');
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                document.getElementById('pageTitle').innerText = 'ç·´é¦¬å¸«æˆ°ç•¥ä½ˆé˜²';
            }
        }

        function renderStrategy(data) {
            const container = document.getElementById('strategy-container');
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">æš«ç„¡åˆ†æè³‡æ–™ (è«‹æª¢æŸ¥ "ç·´é¦¬å¸«åˆ†æ" åˆ†é )ã€‚</div>';
                return;
            }
            container.innerHTML = '';
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'strategy-card';
                div.innerHTML = `<div class="strategy-title">${item.name}</div><div class="strategy-content">${item.content}</div>`;
                container.appendChild(div);
            });
        }

        function renderHomeList(data) {
            const container = document.getElementById('race-list-container');
            container.innerHTML = '';
            data.forEach(race => {
                let colorsHtml = '';
                const colorClasses = ['bg-red', 'bg-red', 'bg-yellow', 'bg-green', 'bg-blue', 'bg-blue'];
                if (race.top6 && Array.isArray(race.top6)) {
                    race.top6.forEach((num, index) => {
                        if(num && index < 6) { colorsHtml += `<div class="c-block ${colorClasses[index]}">${num}</div>`; }
                    });
                }
                const div = document.createElement('div');
                div.className = 'race-card';
                div.onclick = () => goToRace(race.id);
                div.innerHTML = `
                    <div class="race-card-top"><span class="race-id">${race.id}</span><span class="race-meta">${race.class} ${race.dist}</span></div>
                    <div class="race-card-body">
                        <div><div class="stat-row"><span class="stat-label">è©•åˆ†:</span> ${race.rating}</div></div>
                        <div>
                            <div class="stat-row"><span class="stat-label">ä¸»åŠ›æä¾›:</span> <span class="stat-value">${race.pick}</span></div>
                            <div class="stat-row"><span class="stat-label">ä¸»åŠ›å½©æ± :</span> <span class="stat-value">${race.pool}</span></div>
                            <div class="color-bar">${colorsHtml}</div>
                        </div>
                    </div>`;
                container.appendChild(div);
            });
        }

        function renderQuickNav(currentRaceId) {
            const container = document.getElementById('quick-nav-container');
            container.innerHTML = '';
            if (globalData.races) {
                globalData.races.forEach(race => {
                    const btn = document.createElement('div');
                    btn.className = `quick-nav-btn ${race.id === currentRaceId ? 'active' : ''}`;
                    btn.innerText = race.id;
                    btn.onclick = (e) => { e.stopPropagation(); goToRace(race.id); };
                    container.appendChild(btn);
                });
            }
        }

        function goToRace(raceId) {
            const race = globalData.races.find(r => r.id === raceId);
            if (!race) return;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-detail').classList.add('active');
            document.getElementById('backBtn').style.display = 'block';
            document.getElementById('pageTitle').innerText = raceId + " è³½äº‹è©³æƒ…";
            document.getElementById('detail-race-no').innerText = raceId;
            renderQuickNav(raceId);
            renderHorses(race.horses);
            window.scrollTo(0,0);
        }

        function renderHorses(horses) {
            const container = document.getElementById('horse-container');
            container.innerHTML = '';
            horses.forEach(h => {
                const card = document.createElement('div');
                card.className = 'horse-card';
                card.onclick = function() { toggleDetail(this); };
                const targetIcon = h.icon ? h.icon : '';
                const comment = h.comment || 'æš«ç„¡çŸ­è©•';
                const reason = h.reason || ''; 
                const rankDisplay = (h.rankDisplay) ? h.rankDisplay : "-"; 
                card.innerHTML = `
                    <div class="h-main-row">
                        <div class="h-info-group">
                            <div class="h-num">${h.no}</div>
                            <div class="h-name-box">
                                <div class="h-name">${h.name} <span class="target-icon">${targetIcon}</span></div>
                                <div class="h-sub-info">${h.trainer} | ${h.jockey} | ${h.draw}æª” | ${h.weight}ç£…</div>
                            </div>
                        </div>
                        <div class="h-stat-box odds-val">${h.odds}</div>
                        <div class="h-stat-box rank-val">${rankDisplay}</div>
                        <div class="h-stat-box pos-val">${h.pos}</div>
                    </div>
                    <div class="h-details">
                        <div class="h-details-content">
                            <span class="comment-label">æ©ŸæœƒçŸ­è©• (Mæ¬„)ï¼š</span>${comment}
                            ${reason ? `<div class="reason-section"><span class="reason-label">è©³ç´°åˆ†æ (Næ¬„)ï¼š</span><br>${reason}</div>` : ''}
                        </div>
                    </div>`;
                container.appendChild(card);
            });
        }

        function toggleDetail(card) {
            card.classList.toggle('expanded');
            const content = card.querySelector('.h-details');
            if (card.classList.contains('expanded')) content.style.maxHeight = content.scrollHeight + "px";
            else content.style.maxHeight = null;
        }
    </script>
</body>
</html>