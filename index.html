<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∞èÂº∑‚ÄúË≥ΩÈ¶¨Á†îÁ©∂ÊâÄ‚Äú</title>
    <style>
        /* --- Âü∫Á§éË®≠ÂÆö --- */
        :root {
            --primary-bg: #f2f4f8;
            --header-bg: #2c3e50;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --accent-green: #27ae60;
            --highlight-orange: #f39c12;
            --odds-red: #e74c3c;
        }

        body {
            font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--primary-bg);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }

        /* ËÆÄÂèñ‰∏≠ÁöÑÈÅÆÁΩ© */
        #loading-mask {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: #333;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #ddd;
            border-top: 4px solid var(--header-bg);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- Â∞éËà™Ê¨Ñ --- */
        .app-header {
            background-color: var(--header-bg);
            color: white;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title { font-size: 1.1rem; font-weight: bold; }
        
        .back-btn {
            background: none; border: none; color: white;
            font-size: 1.2rem; cursor: pointer; padding-right: 15px;
            display: none;
        }

        /* --- È†ÅÈù¢ÂÆπÂô® --- */
        .page {
            display: none; padding: 10px; padding-bottom: 60px;
            animation: fadeIn 0.3s ease;
        }
        .page.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- È¶ñÈ†Å --- */
        .race-info-header {
            background: white; padding: 10px 15px; border-radius: 8px;
            margin-bottom: 10px; font-size: 0.9rem; color: var(--text-sub);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between;
        }

        .race-card {
            background: var(--card-bg); border-radius: 10px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden;
            cursor: pointer; transition: transform 0.1s;
        }
        .race-card:active { transform: scale(0.98); }

        .race-card-top {
            padding: 12px 15px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .race-id { font-size: 1.1rem; font-weight: bold; color: #2c3e50; }
        .race-meta { font-size: 0.9rem; color: var(--text-sub); }

        .race-card-body {
            padding: 12px 15px; display: grid;
            grid-template-columns: 1fr 1.3fr; gap: 10px;
        }
        .stat-row { margin-bottom: 5px; font-size: 0.9rem; display: flex; align-items: center; }
        .stat-label { color: var(--text-sub); margin-right: 5px; font-size: 0.85rem; }
        .stat-value { font-weight: bold; color: #333; }

        .color-bar { display: flex; gap: 4px; margin-top: 8px; }
        .c-block {
            width: 22px; height: 22px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 0.8rem; font-weight: bold;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .bg-red { background-color: #e74c3c; }
        .bg-yellow { background-color: #f1c40f; }
        .bg-green { background-color: #2ecc71; }
        .bg-blue { background-color: #3498db; }

        /* --- ÂÖßÈ†Å --- */
        .detail-header-info {
            text-align: center; margin-bottom: 15px; color: #555; font-size: 0.9rem;
        }
        .horse-list-header {
            display: grid; grid-template-columns: 3.5fr 1fr 1fr 1fr;
            padding: 0 10px 5px 10px; font-size: 0.8rem; color: #888;
        }

        .horse-card {
            background: white; border-radius: 8px; margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;
        }

        .h-main-row {
            padding: 12px 10px; display: grid;
            grid-template-columns: 3.5fr 1fr 1fr 1fr;
            align-items: center; border-bottom: 1px solid transparent;
        }
        .horse-card.expanded .h-main-row {
            background-color: #f9f9f9; border-bottom: 1px solid #eee;
        }

        .h-info-group { display: flex; align-items: center; }
        .h-num {
            background-color: var(--accent-green); color: white;
            width: 24px; height: 24px; border-radius: 4px;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.85rem; font-weight: bold; margin-right: 8px; flex-shrink: 0;
        }
        .h-name-box { display: flex; flex-direction: column; }
        .h-name { font-weight: bold; font-size: 1rem; display: flex; align-items: center; }
        .target-icon { font-size: 0.8rem; margin-left: 5px; }
        .h-sub-info { font-size: 0.75rem; color: #777; margin-top: 2px; }

        .h-stat-box { text-align: center; font-size: 0.95rem; font-weight: bold; }
        .odds-val { color: var(--odds-red); background: #fceceb; padding: 2px 4px; border-radius: 4px; }
        .rank-val { color: #333; }
        .pos-val { color: #2980b9; font-size: 0.85rem; }

        .h-details {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
            background-color: #fdfdfd;
        }
        .h-details-content {
            padding: 12px 15px; font-size: 0.9rem; color: #444;
            line-height: 1.5; border-top: 1px dashed #eee;
        }
        
        .comment-label { color: var(--highlight-orange); font-weight: bold; margin-bottom: 4px; display: block; }
        .reason-section { margin-top: 10px; border-top: 1px solid #eee; padding-top: 8px; }
        .reason-label { color: #2980b9; font-weight: bold; font-size: 0.85rem; }

        /* Â∫ïÈÉ®Â∞éËà™ */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: white;
            border-top: 1px solid #ddd; display: flex; justify-content: space-around;
            padding: 10px 0; z-index: 99;
        }
        .nav-item { font-size: 0.7rem; text-align: center; color: #999; }
        .nav-item.active { color: var(--header-bg); }
        .nav-icon { font-size: 1.2rem; display: block; margin-bottom: 2px;}

    </style>
</head>
<body>

    <!-- ËºâÂÖ•‰∏≠ÈÅÆÁΩ© -->
    <div id="loading-mask">
        <div class="spinner"></div>
        <div>Ë≥áÊñôËÆÄÂèñ‰∏≠...</div>
    </div>

    <!-- È†ÇÈÉ®Â∞éËà™ -->
    <header class="app-header">
        <button class="back-btn" id="backBtn" onclick="goHome()">‚ùÆ</button>
        <div class="header-title" id="pageTitle">Â∞èÂº∑‚ÄúË≥ΩÈ¶¨Á†îÁ©∂ÊâÄ‚Äú</div>
        <div style="width: 30px;"></div>
    </header>

    <!-- È†ÅÈù¢ 1ÔºöË≥Ω‰∫ãÁ∏ΩË°® -->
    <div id="page-home" class="page">
        <div class="race-info-header" id="today-info">
            <span>üìÖ Êõ¥Êñ∞‰∏≠...</span>
            <span>üìç Ë≥ΩÈ¶¨Êó•</span>
        </div>
        <div id="race-list-container">
            <!-- JS Ëá™ÂãïÁîüÊàê -->
        </div>
    </div>

    <!-- È†ÅÈù¢ 2ÔºöÂ†¥Ê¨°Ë©≥ÊÉÖ -->
    <div id="page-detail" class="page">
        <div class="detail-header-info">
            <span id="detail-race-no">R?</span> - Â∞èÂº∑Ê©üÊúÉÊèê‰æõ
        </div>
        <div class="horse-list-header">
            <div>È¶¨ÂåπË≥áÊñô</div>
            <div style="text-align:center">Ë≥†Áéá</div>
            <div style="text-align:center">Ë≥†ÁéáÊéíÂ∫è</div>
            <div style="text-align:center">Ëµ∞‰Ωç</div>
        </div>
        <div id="horse-container">
            <!-- JS Ëá™ÂãïÁîüÊàê -->
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active"><span class="nav-icon">üìä</span>Áµ±Ë®à</div>
        <div class="nav-item"><span class="nav-icon">üêé</span>È¶¨Âåπ</div>
        <div class="nav-item"><span class="nav-icon">üë§</span>Áî®Êà∂</div>
    </div>

    <script>
        // ============================================
        // üî¥ Ë´ãÂú®ÈÄôË£°Ë≤º‰∏ä‰Ω†ÁöÑ Google Script Á∂≤ÂùÄ
        const SCRIPT_URL = "https://script.google.com/macros/s/‰Ω†ÁöÑ_APPS_SCRIPT_URL_Ë≤ºÂú®ÈÄôË£°/exec";
        // ============================================

        let globalData = []; // Â≠òÂÑ≤‰∏ãËºâÁöÑË≥áÊñô

        // ÂàùÂßãÂåñÔºöËºâÂÖ•Êï∏Êìö
        window.onload = async function() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                globalData = data;
                
                renderHomeList(globalData);
                
                // Ë®≠ÂÆöÊó•Êúü (Á∞°ÂñÆÊäì‰ªäÂ§©Êó•Êúü)
                const d = new Date();
                document.querySelector('#today-info span:first-child').innerText = 
                    `üìÖ ${d.getMonth()+1}Êúà${d.getDate()}Êó•`;
                
                document.getElementById('loading-mask').style.display = 'none';
                document.getElementById('page-home').classList.add('active');

            } catch (error) {
                alert("Ë≥áÊñôËÆÄÂèñÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÊàñ Script Á∂≤ÂùÄ„ÄÇ\n" + error);
                document.getElementById('loading-mask').innerText = "ËÆÄÂèñÂ§±Êïó";
            }
        };

        // Ê∏≤ÊüìÈ¶ñÈ†ÅÂàóË°®
        function renderHomeList(data) {
            const container = document.getElementById('race-list-container');
            container.innerHTML = '';

            data.forEach(race => {
                // ÁîüÊàêÈ°èËâ≤ÊñπÂ°ä HTML
                let colorsHtml = '';
                const colorClasses = ['bg-red', 'bg-red', 'bg-yellow', 'bg-green', 'bg-blue'];
                
                race.colors.forEach((num, index) => {
                    if(num && index < 5) {
                        colorsHtml += `<div class="c-block ${colorClasses[index]}">${num}</div>`;
                    }
                });

                const div = document.createElement('div');
                div.className = 'race-card';
                div.onclick = () => goToRace(race.id);
                div.innerHTML = `
                    <div class="race-card-top">
                        <span class="race-id">${race.id}</span>
                        <span class="race-meta">${race.class} ${race.dist}</span>
                    </div>
                    <div class="race-card-body">
                        <div>
                            <div class="stat-row"><span class="stat-label">Ë©ïÂàÜ:</span> ${race.rating}</div>
                        </div>
                        <div>
                            <div class="stat-row"><span class="stat-label">‰∏ªÂäõÊèê‰æõ:</span> <span class="stat-value">${race.pick}</span></div>
                            <div class="stat-row"><span class="stat-label">‰∏ªÂäõÂΩ©Ê±†:</span> <span class="stat-value">${race.pool}</span></div>
                            <div class="color-bar">
                                ${colorsHtml}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // È†ÅÈù¢ÂàáÊèõÔºöÈÄ≤ÂÖ•ÂÖßÈ†Å
        function goToRace(raceId) {
            const race = globalData.find(r => r.id === raceId);
            if (!race) return;

            document.getElementById('page-home').classList.remove('active');
            document.getElementById('page-detail').classList.add('active');
            
            document.getElementById('backBtn').style.display = 'block';
            document.getElementById('pageTitle').innerText = raceId + " Ë≥Ω‰∫ãË©≥ÊÉÖ";
            document.getElementById('detail-race-no').innerText = raceId;

            renderHorses(race.horses);
            window.scrollTo(0,0);
        }

        // È†ÅÈù¢ÂàáÊèõÔºöËøîÂõûÈ¶ñÈ†Å
        function goHome() {
            document.getElementById('page-detail').classList.remove('active');
            document.getElementById('page-home').classList.add('active');
            
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('pageTitle').innerText = 'Â∞èÂº∑‚ÄúË≥ΩÈ¶¨Á†îÁ©∂ÊâÄ‚Äú';
        }

        // Ê∏≤ÊüìÈ¶¨ÂåπÂàóË°®
        function renderHorses(horses) {
            const container = document.getElementById('horse-container');
            container.innerHTML = '';

            // ÈÄôË£°Â∑≤Á∂ìÊòØÂæåÁ´ØÊéíÂ•ΩÂ∫è (Column K) ÁöÑË≥áÊñô‰∫ÜÔºåÁõ¥Êé•Ê∏≤ÊüìÂç≥ÂèØ
            horses.forEach(h => {
                const card = document.createElement('div');
                card.className = 'horse-card';
                card.onclick = function() { toggleDetail(this); };
                
                // ËôïÁêÜ undefined ÊàñÁ©∫ÂÄº
                const targetIcon = h.icon ? h.icon : '';
                const comment = h.comment || 'Êö´ÁÑ°Áü≠Ë©ï';
                const reason = h.reason || ''; 

                card.innerHTML = `
                    <div class="h-main-row">
                        <div class="h-info-group">
                            <div class="h-num">${h.no}</div>
                            <div class="h-name-box">
                                <div class="h-name">${h.name} <span class="target-icon">${targetIcon}</span></div>
                                <div class="h-sub-info">${h.trainer} | ${h.jockey} | ${h.draw}Ê™î | ${h.weight}Á£Ö</div>
                            </div>
                        </div>
                        <div class="h-stat-box odds-val">${h.odds}</div>
                        <div class="h-stat-box rank-val">${h.rank}</div>
                        <div class="h-stat-box pos-val">${h.pos}</div>
                    </div>
                    <div class="h-details">
                        <div class="h-details-content">
                            <span class="comment-label">Ê©üÊúÉÁü≠Ë©ï (MÊ¨Ñ)Ôºö</span>
                            ${comment}
                            
                            ${reason ? `
                            <div class="reason-section">
                                <span class="reason-label">Ë©≥Á¥∞ÂàÜÊûê (NÊ¨Ñ)Ôºö</span><br>
                                ${reason}
                            </div>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Â±ïÈñã/Êî∂Ëµ∑
        function toggleDetail(card) {
            card.classList.toggle('expanded');
            const content = card.querySelector('.h-details');
            if (card.classList.contains('expanded')) {
                content.style.maxHeight = content.scrollHeight + "px";
            } else {
                content.style.maxHeight = null;
            }
        }
    </script>
</body>
</html>